import{d as Z,R as le,S as oe,r as _,e as P,o as k,m as re,T as ie,U as X,f as G,j as se,g as m,E as B,u as p,N as ue,L as I,c as Y,a as S,z as N,A as ce,G as L,I as Q,K as de}from"./app-GeWjX9nR.js";import{Q as fe}from"./vue-quill.esm-bundler-CJM1gjg1.js";import{_ as F}from"./index-BZs4ypES.js";import{m as ve}from"./useUrl-CBgCp5WS.js";import{_ as he}from"./InlineHeader.vue_vue_type_script_setup_true_lang-CnMW6Ff2.js";import{G as pe,g as ge}from"./pdfjs-dist-DQXiXaQD.js";import{_ as me,a as _e,b as xe,c as we,d as ye,e as be,f as Se,g as Re}from"./DialogTrigger.vue_vue_type_script_setup_true_lang-xDWaSK0z.js";import{L as Ce}from"./loader-circle-2VJqxr5r.js";import"./TextLink.vue_vue_type_script_setup_true_lang-T1_wBD9f.js";import"./Heading.vue_vue_type_script_setup_true_lang-pWtCqrca.js";import"./useForwardPropsEmits-CwhGNt__.js";import"./DialogTitle-BMQK83J-.js";import"./createLucideIcon-BoJrWEEx.js";import"./useForwardExpose-Czjpx7C4.js";import"./index-H4X_E94e.js";import"./Presence-BrU0gijE.js";const Ae=Z({__name:"DragSelection",props:le({selectable:{type:Boolean}},{modelValue:{required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(e,{expose:t}){const o=e,s=oe(e,"modelValue"),l=_(null),A=_(!1),x=_(0),g=_(0),u=_(null);t({canvas:l,cancel:()=>l.value?(A.value=!1,u.value=null,x.value=0,g.value=0,s.value=[],l.value.getContext("2d").clearRect(0,0,l.value.width,l.value.height),!0):void 0});function f(){if(!l.value||!o.selectable)return;const r=l.value.getContext("2d");r.clearRect(0,0,l.value.width,l.value.height),r.strokeStyle="red",r.lineWidth=2,r.setLineDash([5,3]),[...s.value,u.value].forEach(c=>{c&&r.strokeRect(c.x,c.y,c.width,c.height)})}function O(r){if(!l.value||!o.selectable)return;A.value=!0;const c=l.value.getBoundingClientRect();x.value=r.clientX-c.left,g.value=r.clientY-c.top,u.value=null}function R(r){if(!A.value||!l.value||!o.selectable)return;const c=l.value.getBoundingClientRect(),T=r.clientX-c.left,V=r.clientY-c.top;u.value={x:x.value,y:g.value,width:T-x.value,height:V-g.value},f()}function y(){o.selectable&&(u.value&&s.value.push(u.value),u.value=null,A.value=!1,f())}return(r,c)=>(k(),P("canvas",re({ref_key:"canvas",ref:l,class:["absolute top-0 left-0",{"cursor-crosshair":r.selectable}],onMousedown:O,onMousemove:R,onMouseup:y},r.$attrs),null,16))}});var j={},J;function Ee(){if(J)return j;J=1,Object.defineProperty(j,"__esModule",{value:!0});var e={" +":" ",yy:"y",vv:"v","„„":"„","­­":"­","y&":"y","„&":"„","‡u":"u‡",wu:"uw"," ,":","," \\|":"\\|","\\\\ ":""," \\\\":"","\\\\":"","\n +":`
`," +\n":`
`,"\n\n\n\n\n":`

`,"\n\n\n\n":`

`,"\n\n\n":`

`},t={"°":"ক্ক","±":"ক্ট","²":"ক্ষ্ণ","³":"ক্ত","´":"ক্ম",µ:"ক্র","¶":"ক্ষ","·":"ক্স","¸":"গু","¹":"জ্ঞ",º:"গ্দ","»":"গ্ধ","¼":"ঙ্ক","½":"ঙ্গ","¾":"জ্জ","¿":"্ত্র",À:"জ্ঝ",Á:"জ্ঞ",Â:"ঞ্চ",Ã:"ঞ্ছ",Ä:"ঞ্জ",Å:"ঞ্ঝ",Æ:"ট্ট",Ç:"ড্ড",È:"ণ্ট",É:"ণ্ঠ",Ê:"ণ্ড",Ë:"ত্ত",Ì:"ত্থ",Î:"ত্র",Ï:"দ্দ",Ð:"ণ্ড",Ñ:"-",Ò:'"',Ó:'"',Ô:"'",Õ:"'","×":"দ্ধ",Ø:"দ্ব",Ù:"দ্ম",Ú:"ন্ঠ",Û:"ন্ড",Ü:"ন্ধ",Ý:"ন্স",Þ:"প্ট",ß:"প্ত",à:"প্প",á:"প্স",â:"ব্জ",ã:"ব্দ",ä:"ব্ধ",å:"ভ্র",ç:"ম্ফ",é:"ল্ক",ê:"ল্গ",ë:"ল্ট",ì:"ল্ড",í:"ল্প",î:"ল্ফ",ï:"শু",ð:"শ্চ",ñ:"শ্ছ",ò:"ষ্ণ",ó:"ষ্ট",ô:"ষ্ঠ",õ:"ষ্ফ",ö:"স্খ","÷":"স্ট",ø:"স্ন",ù:"স্ফ",û:"হু",ü:"হৃ",ý:"হ্ন",ÿ:"ক্ষ",þ:"হ্ম",A:"অ",B:"ই",C:"ঈ",D:"উ",E:"ঊ",F:"ঋ",G:"এ",H:"ঐ",I:"ও",J:"ঔ",K:"ক",L:"খ",M:"গ",N:"ঘ",O:"ঙ",P:"চ",Q:"ছ",R:"জ",S:"ঝ",T:"ঞ",U:"ট",V:"ঠ",W:"ড",X:"ঢ",Y:"ণ",Z:"ত",_:"থ","`":"দ",a:"ধ",b:"ন",c:"প",d:"ফ",e:"ব",f:"ভ",g:"ম",h:"য",i:"র",j:"ল",k:"শ",l:"ষ",m:"স",n:"হ",o:"ড়",p:"ঢ়",q:"য়",r:"ৎ",s:"ং",t:"ঃ",u:"ঁ",0:"০",1:"১",2:"২",3:"৩",4:"৪",5:"৫",6:"৬",7:"৭",8:"৮",9:"৯","•":"ঙ্","|":"।"},o={"®":"ষ্","¯":"স্","”":"চ্","˜":"দ্","™":"দ্",š:"ন্","›":"ন্","¤":"ম্"},s={"©":"র্"},l={"&":"্‌",ú:"্প",è:"্ন","^":"্ব","‘":"্তু","’":"্থ","‹":"্ক",Œ:"্ক্র","—":"্ত",Í:"্ত",œ:"্ন",Ÿ:"্ব","¡":"্ব","¢":"্ভ","£":"্ভ্র","¥":"্ম","¦":"্ব","§":"্ম","¨":"্য",ª:"্র","«":"্র","¬":"্ল","­":"্ল",Ö:"্র"},A={v:"া",w:"ি",x:"ী",y:"ু",z:"ু",æ:"ু","“":"ু","–":"ু","~":"ূ",ƒ:"ূ","‚":"ূ","„":"ৃ","…":"ৃ","†":"ে","‡":"ে","ˆ":"ৈ","‰":"ৈ",Š:"ৗ"},x={"ো":"ো","ৌ":"ৌ"},g={অা:"আ","্‌্‌":"্‌"},u=Object.assign({},t,o,l);function w(C){return C.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(C,v){return v===void 0&&(v=""),Object.keys(C).map(function(E){return w(E)}).join(v)}var O=new RegExp("(["+f(u,"")+"])","g"),R=new RegExp("([w†‡ˆ‰Š]?)((["+f(o)+"])*(["+f(t,"")+"])?(["+f(l)+"])*)(["+f(s)+"])?([ævxyz“–~ƒ‚„…]?)(["+f(l)+"])*","g"),y=new RegExp("("+w("্")+")+"),r=new RegExp("("+f(e,"|")+")","g"),c=new RegExp("("+f(g,"|")+")","g");function T(C){return u[C]||""}function V(C,v,E,H,D,q,U,i,n,a,h){var d=E.replace(O,T);d=d.replace(y,function(M){return"্"}),d=U?"র্"+d:d,d=n?d+l[n]:d;var b=""+(v?A[v]:"")+(i?A[i]:"");return d=d+(x[b]||b),d}function z(C){var v=C.replace(r,function(E){return e[E]||C});return v=v.replace(R,V),v=v.replace(c,function(E){return g[E]||v}),v}return j.default=z,j}var ke=Ee();const Oe=ie(ke);function ee(e){const t=Math.min(e.x,e.x+e.width),o=Math.min(e.y,e.y+e.height),s=Math.abs(e.width),l=Math.abs(e.height);return{x:t,y:o,width:s,height:l}}function Te(e,t,o){return{x:e.x/t,y:(o.height-(e.y+e.height))/t,width:e.width/t,height:e.height/t}}function Ne(e,t,o){return{x:e.x*t,y:o.height-(e.y+e.height)*t,width:e.width*t,height:e.height*t}}function K(e,t,o){return Te(ee(e),t,o)}function te(e,t){return!(t.x>e.x+e.width||t.x+t.width<e.x||t.y>e.y+e.height||t.y+t.height<e.y)}async function Pe(e,t){if(!t)return[];const o=await t.getTextContent(),s=[];for(const l of o.items){const[A,x,g,u,w,f]=l.transform,O=w,R=f,y=l.width||0,r=u||0,c=ee({x:O,y:R-r,width:y,height:r});if(te(e,c)){const T=Math.sqrt(x*x+u*u);s.push({text:Oe(l.str),fontSizeCSS:T})}}return s}function Me(e){return e>25?"h1":e>18?"h2":e>14?"h3":null}function Be(e){const t=e.charCodeAt(0);return t>=32&&t<=126||t>=160&&t<=255||t>=2432&&t<=2559}function Ve(e){let t="";for(const o of e){let s=o.text.trim();if(s&&Be(s)&&s.length>0&&!s.trim().endsWith(" পাতায় দেখুন")){if(s.includes("নিজস্ব প্রতিবেদক")||s.includes("বিশেষ প্রতিবেদক")){t+=` <b>${o.text}</b>`;continue}const l=Me(o.fontSizeCSS);l?t+=`<${l}>${o.text}</${l}>`:t+=` ${o.text}`}}return t}const $e="/build/assets/pdf.worker.min-r-TJsTTt.mjs",Ie={class:"p-6 relative"},Le={class:"relative w-full h-[76dvh] space-y-4 overflow-y-auto"},Fe={key:0,class:"absolute bg-background w-full h-dvh z-50 flex items-center justify-center"},je={class:"space-y-8 max-h-[80dvh] overflow-y-auto"},ze={breadcrumbs:[{title:"Epaper",href:route("epapers.index")},{title:"Configure Epaper",href:"#"},{title:"Epaper Page",href:location.href}]},lt=Z({...ze,inheritAttrs:!1,__name:"Show",props:{epage:{}},setup(e){pe.workerSrc=$e;const t=e,o=_(null),s=X("overlay"),l=_(null),A=_(),x=_([]),g=_(!0),u=_(!1),w=_([]),f=_(!1),O=_(!1),R=X("savedArticleBoxes");let y,r,c=[];const T=G(()=>{const i=y.getViewport({scale:1}),n=i.width,a=i.height,h=l.value.clientWidth;return l.value.style.height=`${h*(a/n)}px`,Math.min(h/n,l.value.clientHeight/a)}),V=G(()=>new URLSearchParams(window.location.search).get("extending_article")),z=i=>{const n=i.drawImage.bind(i);return function(...a){const h=i.getTransform();let d=0,b=0,M=0,$=0,W=a[0];a.length===3?(d=a[1],b=a[2],M=W.width,$=W.height):a.length===5?(d=a[1],b=a[2],M=a[3],$=a[4]):a.length===9&&(d=a[5],b=a[6],M=a[7],$=a[8]);const ne=h.a*d+h.c*b+h.e,ae=h.b*d+h.d*b+h.f;return M>0&&$>0&&c.push({rectPdf:K({x:ne,y:ae,width:M*h.a,height:$*h.d},r.scale,o.value),image:W}),n(...a)}};async function C(){if(y){g.value=!0;for(const i of x.value){const n=K(i,r.scale,o.value),a=await Pe(n,y),h=Ve(a),d=c.filter(b=>te(b.rectPdf,n));w.value.push({type:"text",bounding_box:n,extracted_content:h});for(const b of d)w.value.push({type:"image",bounding_box:b.rectPdf})}g.value=!1,f.value=!0}}const v=()=>{s.value?.cancel()&&(u.value=!1,w.value=[])},E=async()=>{if(!u.value){u.value=!0;return}await C()},H=i=>{const n=Ne(i.bounding_box,r.scale,o.value);return{top:n.y,left:n.x,width:n.width,height:n.height}},D=()=>{for(const i in t.epage.article_boxes){const n=t.epage.article_boxes[i],a=H(n);R.value[i].style.top=a.top+"px",R.value[i].style.left=a.left+"px",R.value[i].style.width=a.width+"px",R.value[i].style.height=a.height+"px"}},q=()=>{de.post(route("epage.articles.store",{epage:t.epage.id}),{article_boxes:w.value,add_selection_from_other_page:O.value??!1,article:V.value??null},{onSuccess:()=>{v(),D()},onFinish:()=>w.value=[],preserveScroll:!0,preserveState:!0})},U=()=>{O.value=!0,E()};return se(async()=>{if(!l.value||!o.value||!s.value?.canvas)return;g.value=!0,y=await(await ge(ve(t.epage.epaper.pdf_path)).promise).getPage(t.epage.page_number),r=y.getViewport({scale:T.value}),o.value.width=r.width,o.value.height=r.height,s.value.canvas.width=r.width,s.value.canvas.height=r.height;const n=o.value.getContext("2d");n.drawImage=z(n),await y.render({canvasContext:n,viewport:r,canvas:o.value}).promise,D(),g.value=!1}),(i,n)=>(k(),P(L,null,[m(p(ue),{title:"Epage"}),B("div",Ie,[m(he,{title:"Epaper Page",link:{href:i.route("epapers.edit",{epaper:i.epage.epaper_id}),text:"Back to pages"}},null,8,["link"]),B("div",Le,[g.value?(k(),P("div",Fe,[m(p(Ce),{class:"animate-spin w-32 h-32"})])):I("",!0),B("div",{class:"bg-primary-foreground w-full flex sticky top-0 z-40 py-2 space-x-2",ref_key:"toolbar",ref:A},[m(p(F),{variant:"ghost",onClick:E},{default:S(()=>[N(ce(u.value?"Add":"Select A")+" Article",1)]),_:1}),u.value?(k(),Y(p(F),{key:0,variant:"ghost",onClick:v},{default:S(()=>n[2]||(n[2]=[N("Cancel Selection",-1)])),_:1,__:[2]})):I("",!0),u.value?(k(),Y(p(F),{key:1,variant:"ghost",onClick:U},{default:S(()=>n[3]||(n[3]=[N("Add Selection From Other Page",-1)])),_:1,__:[3]})):I("",!0)],512),B("div",{ref_key:"container",ref:l,class:"relative w-full overflow-hidden"},[B("canvas",{ref_key:"canvas",ref:o,class:"block"},null,512),m(Ae,{modelValue:x.value,"onUpdate:modelValue":n[0]||(n[0]=a=>x.value=a),ref_key:"overlay",ref:s,selectable:u.value},null,8,["modelValue","selectable"]),(k(!0),P(L,null,Q(i.epage.article_boxes,a=>(k(),P("div",{key:a.id,ref_for:!0,ref_key:"savedArticleBoxes",ref:R,class:"absolute bg-red-500 opacity-20 z-20"}))),128))],512)]),m(p(Re),{open:f.value,"onUpdate:open":n[1]||(n[1]=a=>f.value=a)},{default:S(()=>[m(p(me),{as:"div",class:"hidden"},{default:S(()=>n[4]||(n[4]=[N(" Review ",-1)])),_:1,__:[4]}),m(p(_e),null,{default:S(()=>[m(p(xe),null,{default:S(()=>[m(p(we),null,{default:S(()=>n[5]||(n[5]=[N("Review Article",-1)])),_:1,__:[5]}),m(p(ye),null,{default:S(()=>n[6]||(n[6]=[N("Review Your Selected Article",-1)])),_:1,__:[6]})]),_:1}),B("div",je,[(k(!0),P(L,null,Q(w.value,a=>(k(),P(L,null,[a.type==="text"?(k(),Y(p(fe),{key:0,content:a.extracted_content,"onUpdate:content":h=>a.extracted_content=h,"content-type":"html",theme:"snow",class:"h-64"},null,8,["content","onUpdate:content"])):I("",!0)],64))),256))]),m(p(be),null,{default:S(()=>[m(p(Se),null,{default:S(()=>[m(p(F),{onClick:q},{default:S(()=>n[7]||(n[7]=[N("Finalize Article",-1)])),_:1,__:[7]})]),_:1})]),_:1})]),_:1})]),_:1},8,["open"])])],64))}});export{lt as default};
